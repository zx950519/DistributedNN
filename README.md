# 近期工作汇报

## 近期工作列表
- 论文修改
- 专利整理
- 代码Review&整理

## 工作方向简介
- 搭建新的实验环境
- 寻找可突破的方向

## 实验内容简介
本节对实验内容进行简要介绍，包括：背景、调研。

#### 背景
机器学习特别是深度学习，已成为人工智能领域的核心研究内容之一，在图像识别、自然语言处理等领域获得了广泛应用。  

然而，随着训练数据集规模和模型参数数量增长，单机训练模型的模式已经不能满足实际需求。例如，Mnist数据集大小仅115MB，而YAHOO的Flickr Images Features数据集大小为83GB；采用LeNet5求解Mnist时，模型参数数量远远小于具有1000层以上结构的残差神经网络。  

近年来，随着分布式系统发展以及硬件性能的提高，分布式机器学习已经成为业界研究热点。  

#### 调研
分布式/并行机器学习的实现，依赖于对单机串行代码的修改。因此，本节罗列了一些较为成熟的机器学习框架。  
- Caffe一族(C++).Caffe由加州大学伯克利开发的，支持CPU训练与GPU训练。Caffe提供了完整的工具包用于训练、测试及部署模型。Caffe已广泛应用于视觉及语音识别等领域.
- Keras(Python).Keras是一个高层神经网络API，Keras由纯Python编写而成并基于Tensorflow、Theano以及CNTK后端。优点为：简易和快速的原型设计；支持CNN和RNN，或二者的结合；无缝CPU和GPU切换。
- Pytorch(Python).PyTorch是一个Python开源机器学习库，用于自然语言处理等应用程序。它主要由Facebook的人工智能研究小组开发。PyTorch是一个Python包，提供两个高级功能：具有强大的GPU加速的张量计算（如NumPy）；包含自动求导系统的的深度神经网络。  

下面给出上述三种框架定义LeNet的代码：  
```xml
// Caffe2
name: "LeNet"
layers {
  name: "mnist"
  type: DATA
  top: "data"
  top: "label"
  data_param {
    source: "/home/group10/caffe_experiment/baseSSP/examples/mnist/mnist_train_lmdb"
    backend: LMDB
    batch_size: 2
  }
  transform_param {
    scale: 0.00390625
  }
  include: { phase: TRAIN }
}
layers {
  name: "mnist"
  type: DATA
  top: "data"
  top: "label"
  data_param {
    source: "/home/group10/caffe_experiment/baseSSP/examples/mnist/mnist_test_lmdb"
    backend: LMDB
    batch_size: 100
  }
  transform_param {
    scale: 0.00390625
  }
  include: { phase: TEST }
}

layers {
  name: "conv1"
  type: CONVOLUTION
  bottom: "data"
  top: "conv1"
  blobs_lr: 1
  blobs_lr: 2
  convolution_param {
    num_output: 20
    kernel_size: 5
    stride: 1
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
    }
  }
}
layers {
  name: "pool1"
  type: POOLING
  bottom: "conv1"
  top: "pool1"
  pooling_param {
    pool: MAX
    kernel_size: 2
    stride: 2
  }
}
layers {
  name: "conv2"
  type: CONVOLUTION
  bottom: "pool1"
  top: "conv2"
  blobs_lr: 1
  blobs_lr: 2
  convolution_param {
    num_output: 50
    kernel_size: 5
    stride: 1
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
    }
  }
}
layers {
  name: "pool2"
  type: POOLING
  bottom: "conv2"
  top: "pool2"
  pooling_param {
    pool: MAX
    kernel_size: 2
    stride: 2
  }
}
layers {
  name: "ip1"
  type: INNER_PRODUCT
  bottom: "pool2"
  top: "ip1"
  blobs_lr: 1
  blobs_lr: 2
  inner_product_param {
    num_output: 500
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
    }
  }
}
layers {
  name: "relu1"
  type: RELU
  bottom: "ip1"
  top: "ip1"
}
layers {
  name: "ip2"
  type: INNER_PRODUCT
  bottom: "ip1"
  top: "ip2"
  blobs_lr: 1
  blobs_lr: 2
  inner_product_param {
    num_output: 10
    weight_filler {
      type: "xavier"
    }
    bias_filler {
      type: "constant"
    }
  }
}
layers {
  name: "accuracy"
  type: ACCURACY
  bottom: "
}
```
```xml
# Keras
def getLeNet():
    model = Sequential()
    model.add(Conv2D(filters=32, kernel_size=(5, 5), padding='Same',
                     activation='relu', input_shape=(28, 28, 1)))
    model.add(Conv2D(filters=32, kernel_size=(5, 5), padding='Same',
                     activation='relu'))
    model.add(MaxPool2D(pool_size=(2, 2)))
    model.add(Dropout(0.25))
    model.add(Conv2D(filters=64, kernel_size=(3, 3), padding='Same',
                     activation='relu'))
    model.add(Conv2D(filters=64, kernel_size=(3, 3), padding='Same',
                     activation='relu'))
    model.add(MaxPool2D(pool_size=(2, 2), strides=(2, 2)))
    model.add(Dropout(0.25))
    model.add(Flatten())
    model.add(Dense(128, activation="relu"))
    model.add(Dropout(0.5))
    model.add(Dense(10, activation="softmax"))
    return model
```
```xml
# Pytorch
class LeNet(nn.Module):
    def __init__(self):
        super(LeNet, self).__init__()
        self.conv1 = nn.Sequential(     #input_size=(1*28*28)
            nn.Conv2d(1, 6, 5, 1, 2), #padding=2保证输入输出尺寸相同
            nn.ReLU(),      #input_size=(6*28*28)
            nn.MaxPool2d(kernel_size=2, stride=2),#output_size=(6*14*14)
        )
        self.conv2 = nn.Sequential(
            nn.Conv2d(6, 16, 5),
            nn.ReLU(),      #input_size=(16*10*10)
            nn.MaxPool2d(2, 2)  #output_size=(16*5*5)
        )
        self.fc1 = nn.Sequential(
            nn.Linear(16 * 5 * 5, 120),
            nn.ReLU()
        )
        self.fc2 = nn.Sequential(
            nn.Linear(120, 84),
            nn.ReLU()
        )
        self.fc3 = nn.Linear(84, 10)

    # 定义前向传播过程，输入为x
    def forward(self, x):
        x = self.conv1(x)
        x = self.conv2(x)
        # nn.Linear()的输入输出都是维度为一的值，所以要把多维度的tensor展平成一维
        x = x.view(x.size()[0], -1)
        x = self.fc1(x)
        x = self.fc2(x)
        x = self.fc3(x)
        return x
```

## 实验

#### 已有环境
本节对目前已有的环境进行描述。  

- 323集群  
目前，对323已有的空闲节点进行整合，组成了一个小规模集群。该集群由于处于同一机房，同一/不同机柜，因此不够完全"分布式"。集群配置如下：  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2fu775fxoj30mt07qjru.jpg)
- 三教集群  
三教集群目前经过整合，已经可以利用GPU加速训练，单机训练效果提升明显！

#### CPU vs GPU
下述实验均在单机环境下进行：
- 运行Mnist+NIN: CPU-480s/轮 GPU-50s/轮
- 运行Cifar10+ResNet: CPU-10min+/轮 GPU-90s/轮
- 运行Cifar10+DenseNet: CPU-1h+/轮 GPU-10.5min/轮

## 实验设计&实现

#### 架构设计
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2b95dgykij30q90jf761.jpg)  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2i9tgnczij30ji0kcmxv.jpg)  

#### 训练流程(Master视角)
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2b9c6igacj30ke0gkjsd.jpg)

#### 训练流程(Slave视角)  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2futsh620j30t30gtgn3.jpg)


#### Mnist+LeNet演示(CPU)
启动命令：  
```xml
mpirun -n 4 --machinefile machinefile python SchedulerWithoutTest.py
```
超参：  
```xml
epochs = 50
ssp_value = 1
batch_size = 128
test_size = 0.05
vb = 0                              # 控制台输出级别
minGap = 0                          # minGap = 全部数据 * loadFactor
loadFactor = 0.05                   # 随机数据的块增量占全部数据量的百分比
absoluteFactor = 0.8                # 随机数据补全后单节点数据量占全部数据量的百分比
enableRandomIncreation = False      # 是否使用随机数据补全
enableDataAugmentation = False      # 是否使用实时数据增强
```
数据分块：  
```xml
2019-04-22 20:48:00 Print By 0 数据包总大小为: 0.000888824462890625MB
2019-04-22 20:48:00 Print By 0 训练集数据包大小: 6.103515625e-05MB
2019-04-22 20:48:00 Print By 0 训练集标签数据包大小: 6.103515625e-05MB
2019-04-22 20:48:00 Print By 0 测试集数据包大小: 6.103515625e-05MB
2019-04-22 20:48:00 Print By 0 测试集标签数据包大小: 6.103515625e-05MB
2019-04-22 20:48:00 Print By 0 训练轮数数据包大小: 2.6702880859375e-05MB
2019-04-22 20:48:00 Print By 0 数据分块数据包大小: 0.00049591064453125MB
2019-04-22 20:48:00 Print By 0 已完成数据分配, 耗时:1.072秒
2019-04-22 20:47:32 Print By 1 训练轮数 50
2019-04-22 20:47:32 Print By 1 数据块起始坐标0
2019-04-22 20:47:32 Print By 1 数据块终止坐标19999
2019-04-22 20:47:32 Print By 1 数据块大小20000
2019-04-22 20:48:00 Print By 0 已完成数据发送, 耗时:0.001秒
2019-04-22 20:48:00 Print By 3 训练轮数 50
2019-04-22 20:48:00 Print By 2 训练轮数 50
2019-04-22 20:48:00 Print By 3 数据块起始坐标40000
2019-04-22 20:48:00 Print By 3 数据块终止坐标59999
2019-04-22 20:48:00 Print By 3 数据块大小20000
2019-04-22 20:48:00 Print By 2 数据块起始坐标20000
2019-04-22 20:48:00 Print By 2 数据块终止坐标39999
2019-04-22 20:48:00 Print By 2 数据块大小20000
2019-04-22 20:48:02 Print By 2 初始轮
2019-04-22 20:48:02 Print By 2 首次训练 无需加载权重
2019-04-22 20:48:02 Print By 3 初始轮
2019-04-22 20:47:34 Print By 1 初始轮
2019-04-22 20:48:02 Print By 3 首次训练 无需加载权重
2019-04-22 20:47:35 Print By 1 首次训练 无需加载权重
```
第一次训练过程：  
```xml
2019-04-22 20:48:36 Print By 2 已完成Train 耗时:34.579秒
2019-04-22 20:48:36 Print By 2 已完成Test 耗时:0.0秒
2019-04-22 20:48:20 Print By 1 已完成Train 耗时:45.599秒
2019-04-22 20:48:20 Print By 1 已完成Test 耗时:0.0秒
2019-04-22 20:48:20 Print By 1 回传权重数据包大小为: 1.8508520126342773MB
2019-04-22 20:48:48 Print By 2 回传权重数据包大小为: 1.8508520126342773MB
2019-04-22 20:49:04 Print By 3 已完成Train 耗时:61.212秒
2019-04-22 20:49:04 Print By 3 已完成Test 耗时:0.0秒
2019-04-22 20:49:04 Print By 3 回传权重数据包大小为: 1.8508520126342773MB
2019-04-22 20:49:04 Print By 0 已完成数据回收, 本轮训练总耗时:63.349秒
2019-04-22 20:49:04 Print By 0 开始聚合...

  128/10000 [..............................] - ETA: 10s
  384/10000 [>.............................] - ETA: 5s 
  640/10000 [>.............................] - ETA: 3s
  896/10000 [=>............................] - ETA: 3s
 1152/10000 [==>...........................] - ETA: 2s
 1536/10000 [===>..........................] - ETA: 2s
 1792/10000 [====>.........................] - ETA: 2s
 2048/10000 [=====>........................] - ETA: 2s
 2304/10000 [=====>........................] - ETA: 1s
 2688/10000 [=======>......................] - ETA: 1s
 2944/10000 [=======>......................] - ETA: 1s
 3200/10000 [========>.....................] - ETA: 1s
 3456/10000 [=========>....................] - ETA: 1s
 3712/10000 [==========>...................] - ETA: 1s
 4096/10000 [===========>..................] - ETA: 1s
 4352/10000 [============>.................] - ETA: 1s
 4736/10000 [=============>................] - ETA: 1s
 4992/10000 [=============>................] - ETA: 1s
 5248/10000 [==============>...............] - ETA: 1s
 5504/10000 [===============>..............] - ETA: 1s
 5760/10000 [================>.............] - ETA: 0s
 6144/10000 [=================>............] - ETA: 0s
 6400/10000 [==================>...........] - ETA: 0s
 6656/10000 [==================>...........] - ETA: 0s
 6912/10000 [===================>..........] - ETA: 0s
 7168/10000 [====================>.........] - ETA: 0s
 7424/10000 [=====================>........] - ETA: 0s
 7680/10000 [======================>.......] - ETA: 0s
 7936/10000 [======================>.......] - ETA: 0s
 8192/10000 [=======================>......] - ETA: 0s
 8448/10000 [========================>.....] - ETA: 0s
 8704/10000 [=========================>....] - ETA: 0s
 9088/10000 [==========================>...] - ETA: 0s
 9472/10000 [===========================>..] - ETA: 0s
 9728/10000 [============================>.] - ETA: 0s
 9984/10000 [============================>.] - ETA: 0s
10000/10000 [==============================] - 2s 216us/step
2019-04-22 20:49:07 Print By 0 聚合后的Loss: 2.2586552951812746
2019-04-22 20:49:07 Print By 0 聚合后的Accurary: 0.2728
2019-04-22 20:49:07 Print By 0 已完成权重聚合, 耗时:3.451秒
2019-04-22 20:49:07 Print By 0 本轮: 0 训练结束...  
```
第20次训练过程：  
```xml
2019-04-22 20:58:08 Print By 2 已完成Train 耗时:10.974秒
2019-04-22 20:58:08 Print By 2 已完成Test 耗时:0.0秒
2019-04-22 20:57:52 Print By 1 已完成Train 耗时:21.409秒
2019-04-22 20:57:52 Print By 1 已完成Test 耗时:0.0秒
2019-04-22 20:57:52 Print By 1 回传权重数据包大小为: 1.8508520126342773MB
2019-04-22 20:58:20 Print By 2 回传权重数据包大小为: 1.8508520126342773MB
2019-04-22 20:58:20 Print By 3 已完成Train 耗时:22.462秒
2019-04-22 20:58:20 Print By 3 已完成Test 耗时:0.0秒
2019-04-22 20:58:20 Print By 3 回传权重数据包大小为: 1.8508520126342773MB
2019-04-22 20:58:20 Print By 0 已完成数据回收, 本轮训练总耗时:27.081秒
2019-04-22 20:58:20 Print By 0 开始聚合...

  128/10000 [..............................] - ETA: 19s
  384/10000 [>.............................] - ETA: 7s 
  768/10000 [=>............................] - ETA: 4s
 1024/10000 [==>...........................] - ETA: 3s
 1280/10000 [==>...........................] - ETA: 3s
 1664/10000 [===>..........................] - ETA: 2s
 2048/10000 [=====>........................] - ETA: 2s
 2304/10000 [=====>........................] - ETA: 2s
 2560/10000 [======>.......................] - ETA: 2s
 2944/10000 [=======>......................] - ETA: 1s
 3328/10000 [========>.....................] - ETA: 1s
 3712/10000 [==========>...................] - ETA: 1s
 4096/10000 [===========>..................] - ETA: 1s
 4480/10000 [============>.................] - ETA: 1s
 4864/10000 [=============>................] - ETA: 1s
 5248/10000 [==============>...............] - ETA: 1s
 5632/10000 [===============>..............] - ETA: 1s
 6016/10000 [=================>............] - ETA: 0s
 6400/10000 [==================>...........] - ETA: 0s
 6784/10000 [===================>..........] - ETA: 0s
 7040/10000 [====================>.........] - ETA: 0s
 7424/10000 [=====================>........] - ETA: 0s
 7808/10000 [======================>.......] - ETA: 0s
 8192/10000 [=======================>......] - ETA: 0s
 8576/10000 [========================>.....] - ETA: 0s
 8960/10000 [=========================>....] - ETA: 0s
 9216/10000 [==========================>...] - ETA: 0s
 9472/10000 [===========================>..] - ETA: 0s
 9856/10000 [============================>.] - ETA: 0s
10000/10000 [==============================] - 2s 213us/step
2019-04-22 20:58:24 Print By 0 聚合后的Loss: 0.08290998245775699
2019-04-22 20:58:24 Print By 0 聚合后的Accurary: 0.9716
2019-04-22 20:58:24 Print By 0 已完成权重聚合, 耗时:3.914秒
2019-04-22 20:58:24 Print By 0 本轮: 19 训练结束...  
```
全部训练统计：  
```xml
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第0轮准确率为: 0.2728
2019-04-22 21:16:46 Print By 0 第0轮耗时为: 66.801秒
2019-04-22 21:16:46 Print By 0 已完成本次任务，耗时:1726.918秒
2019-04-22 21:16:46 Print By 0 第0轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第0轮Loss为:2.2586552951812746
Using TensorFlow backend.
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第1轮准确率为: 0.8426
2019-04-22 21:16:46 Print By 0 第1轮耗时为: 27.918秒
2019-04-22 21:16:46 Print By 0 第1轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:18 Print By 0 已完成本次任务，耗时:1726.814秒
2019-04-22 21:16:46 Print By 0 第1轮Loss为:0.5792151268482209
Using TensorFlow backend.
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第2轮准确率为: 0.8917
2019-04-22 21:16:46 Print By 0 第2轮耗时为: 26.886秒
2019-04-22 21:16:46 Print By 0 第2轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第2轮Loss为:0.3914984824180603
2019-04-22 21:16:46 Print By 0 已完成本次任务，耗时:1726.764秒
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第3轮准确率为: 0.9117
2019-04-22 21:16:46 Print By 0 第3轮耗时为: 27.916秒
2019-04-22 21:16:46 Print By 0 第3轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第3轮Loss为:0.30387250056266785
Using TensorFlow backend.
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第4轮准确率为: 0.9254
2019-04-22 21:16:46 Print By 0 第4轮耗时为: 28.317秒
2019-04-22 21:16:46 Print By 0 第4轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第4轮Loss为:0.25285532650947573
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第5轮准确率为: 0.9363
2019-04-22 21:16:46 Print By 0 第5轮耗时为: 28.44秒
2019-04-22 21:16:46 Print By 0 第5轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第5轮Loss为:0.21511693999767303
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第6轮准确率为: 0.9447
2019-04-22 21:16:46 Print By 0 第6轮耗时为: 28.75秒
2019-04-22 21:16:46 Print By 0 第6轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第6轮Loss为:0.1900375174999237
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第7轮准确率为: 0.9504
2019-04-22 21:16:46 Print By 0 第7轮耗时为: 29.138秒
2019-04-22 21:16:46 Print By 0 第7轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第7轮Loss为:0.16758616766929627
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第8轮准确率为: 0.9547
2019-04-22 21:16:46 Print By 0 第8轮耗时为: 28.073秒
2019-04-22 21:16:46 Print By 0 第8轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第8轮Loss为:0.15158228217363356
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第9轮准确率为: 0.9565
2019-04-22 21:16:46 Print By 0 第9轮耗时为: 27.988秒
2019-04-22 21:16:46 Print By 0 第9轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第9轮Loss为:0.14012820625305175
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第10轮准确率为: 0.9602
2019-04-22 21:16:46 Print By 0 第10轮耗时为: 28.352秒
2019-04-22 21:16:46 Print By 0 第10轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第10轮Loss为:0.12864635763168336
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第11轮准确率为: 0.9608
2019-04-22 21:16:46 Print By 0 第11轮耗时为: 28.665秒
2019-04-22 21:16:46 Print By 0 第11轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第11轮Loss为:0.12261171006560326
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第12轮准确率为: 0.9634
2019-04-22 21:16:46 Print By 0 第12轮耗时为: 28.955秒
2019-04-22 21:16:46 Print By 0 第12轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第12轮Loss为:0.11325658151209354
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第13轮准确率为: 0.9661
2019-04-22 21:16:46 Print By 0 第13轮耗时为: 30.394秒
2019-04-22 21:16:46 Print By 0 第13轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第13轮Loss为:0.10784920729994774
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第14轮准确率为: 0.9666
2019-04-22 21:16:46 Print By 0 第14轮耗时为: 31.1秒
2019-04-22 21:16:46 Print By 0 第14轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第14轮Loss为:0.10170719488561153
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第15轮准确率为: 0.968
2019-04-22 21:16:46 Print By 0 第15轮耗时为: 29.392秒
2019-04-22 21:16:46 Print By 0 第15轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第15轮Loss为:0.09809902372658252
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第16轮准确率为: 0.9699
2019-04-22 21:16:46 Print By 0 第16轮耗时为: 31.175秒
2019-04-22 21:16:46 Print By 0 第16轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第16轮Loss为:0.0945609541207552
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第17轮准确率为: 0.9703
2019-04-22 21:16:46 Print By 0 第17轮耗时为: 32.208秒
2019-04-22 21:16:46 Print By 0 第17轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第17轮Loss为:0.09141022311449051
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第18轮准确率为: 0.9706
2019-04-22 21:16:46 Print By 0 第18轮耗时为: 32.177秒
2019-04-22 21:16:46 Print By 0 第18轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第18轮Loss为:0.08823055919185281
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第19轮准确率为: 0.9716
2019-04-22 21:16:46 Print By 0 第19轮耗时为: 31.143秒
2019-04-22 21:16:46 Print By 0 第19轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第19轮Loss为:0.08290998245775699
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第20轮准确率为: 0.9729
2019-04-22 21:16:46 Print By 0 第20轮耗时为: 33.242秒
2019-04-22 21:16:46 Print By 0 第20轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第20轮Loss为:0.0810331455335021
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第21轮准确率为: 0.9733
2019-04-22 21:16:46 Print By 0 第21轮耗时为: 34.7秒
2019-04-22 21:16:46 Print By 0 第21轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第21轮Loss为:0.07747118739634752
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第22轮准确率为: 0.9741
2019-04-22 21:16:46 Print By 0 第22轮耗时为: 32.94秒
2019-04-22 21:16:46 Print By 0 第22轮网络流量为:0.009290695190429688MB
2019-04-22 21:16:46 Print By 0 第22轮Loss为:0.07674421205297112
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第23轮准确率为: 0.9758
2019-04-22 21:16:46 Print By 0 第23轮耗时为: 33.857秒
2019-04-22 21:16:46 Print By 0 第23轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第23轮Loss为:0.07546569016054272
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第24轮准确率为: 0.9761
2019-04-22 21:16:46 Print By 0 第24轮耗时为: 32.603秒
2019-04-22 21:16:46 Print By 0 第24轮网络流量为:0.00930023193359375MB
2019-04-22 21:16:46 Print By 0 第24轮Loss为:0.07094746184721588
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第25轮准确率为: 0.9765
2019-04-22 21:16:46 Print By 0 第25轮耗时为: 32.775秒
2019-04-22 21:16:46 Print By 0 第25轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第25轮Loss为:0.06977988999560475
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第26轮准确率为: 0.977
2019-04-22 21:16:46 Print By 0 第26轮耗时为: 33.342秒
2019-04-22 21:16:46 Print By 0 第26轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第26轮Loss为:0.06792269162386656
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第27轮准确率为: 0.9774
2019-04-22 21:16:46 Print By 0 第27轮耗时为: 34.497秒
2019-04-22 21:16:46 Print By 0 第27轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第27轮Loss为:0.06619511256925761
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第28轮准确率为: 0.9784
2019-04-22 21:16:46 Print By 0 第28轮耗时为: 34.665秒
2019-04-22 21:16:46 Print By 0 第28轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第28轮Loss为:0.0643742676820606
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第29轮准确率为: 0.9784
2019-04-22 21:16:46 Print By 0 第29轮耗时为: 36.313秒
2019-04-22 21:16:46 Print By 0 第29轮网络流量为:0.009285926818847656MB
2019-04-22 21:16:46 Print By 0 第29轮Loss为:0.06425215021073818
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第30轮准确率为: 0.9779
2019-04-22 21:16:46 Print By 0 第30轮耗时为: 36.319秒
2019-04-22 21:16:46 Print By 0 第30轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第30轮Loss为:0.06270606694743038
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第31轮准确率为: 0.9787
2019-04-22 21:16:46 Print By 0 第31轮耗时为: 35.556秒
2019-04-22 21:16:46 Print By 0 第31轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第31轮Loss为:0.06064387189056724
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第32轮准确率为: 0.979
2019-04-22 21:16:46 Print By 0 第32轮耗时为: 36.046秒
2019-04-22 21:16:46 Print By 0 第32轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第32轮Loss为:0.05965426866821945
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第33轮准确率为: 0.9796
2019-04-22 21:16:46 Print By 0 第33轮耗时为: 36.013秒
2019-04-22 21:16:46 Print By 0 第33轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第33轮Loss为:0.05850402984265238
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第34轮准确率为: 0.9796
2019-04-22 21:16:46 Print By 0 第34轮耗时为: 35.954秒
2019-04-22 21:16:46 Print By 0 第34轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第34轮Loss为:0.05825547371730208
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第35轮准确率为: 0.9808
2019-04-22 21:16:46 Print By 0 第35轮耗时为: 37.561秒
2019-04-22 21:16:46 Print By 0 第35轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第35轮Loss为:0.05617346662469208
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第36轮准确率为: 0.9819
2019-04-22 21:16:46 Print By 0 第36轮耗时为: 38.689秒
2019-04-22 21:16:46 Print By 0 第36轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第36轮Loss为:0.054319329774379733
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第37轮准确率为: 0.9812
2019-04-22 21:16:46 Print By 0 第37轮耗时为: 39.118秒
2019-04-22 21:16:46 Print By 0 第37轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第37轮Loss为:0.05510828792601824
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第38轮准确率为: 0.9816
2019-04-22 21:16:46 Print By 0 第38轮耗时为: 38.012秒
2019-04-22 21:16:46 Print By 0 第38轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第38轮Loss为:0.05386417986806482
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第39轮准确率为: 0.982
2019-04-22 21:16:46 Print By 0 第39轮耗时为: 37.978秒
2019-04-22 21:16:46 Print By 0 第39轮网络流量为:0.009305000305175781MB
2019-04-22 21:16:46 Print By 0 第39轮Loss为:0.052043442137353124
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第40轮准确率为: 0.9819
2019-04-22 21:16:46 Print By 0 第40轮耗时为: 38.32秒
2019-04-22 21:16:46 Print By 0 第40轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第40轮Loss为:0.05219449130455032
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第41轮准确率为: 0.9823
2019-04-22 21:16:46 Print By 0 第41轮耗时为: 39.156秒
2019-04-22 21:16:46 Print By 0 第41轮网络流量为:0.00930023193359375MB
2019-04-22 21:16:46 Print By 0 第41轮Loss为:0.05135351879494265
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第42轮准确率为: 0.9826
2019-04-22 21:16:46 Print By 0 第42轮耗时为: 38.701秒
2019-04-22 21:16:46 Print By 0 第42轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第42轮Loss为:0.049333363196067515
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第43轮准确率为: 0.9831
2019-04-22 21:16:46 Print By 0 第43轮耗时为: 38.73秒
2019-04-22 21:16:46 Print By 0 第43轮网络流量为:0.00930023193359375MB
2019-04-22 21:16:46 Print By 0 第43轮Loss为:0.04886616319012828
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第44轮准确率为: 0.9836
2019-04-22 21:16:46 Print By 0 第44轮耗时为: 37.426秒
2019-04-22 21:16:46 Print By 0 第44轮网络流量为:0.009285926818847656MB
2019-04-22 21:16:46 Print By 0 第44轮Loss为:0.048763389141019436
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第45轮准确率为: 0.9836
2019-04-22 21:16:46 Print By 0 第45轮耗时为: 38.697秒
2019-04-22 21:16:46 Print By 0 第45轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第45轮Loss为:0.04879935402474366
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第46轮准确率为: 0.9831
2019-04-22 21:16:46 Print By 0 第46轮耗时为: 39.706秒
2019-04-22 21:16:46 Print By 0 第46轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第46轮Loss为:0.04725071767512709
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第47轮准确率为: 0.9824
2019-04-22 21:16:46 Print By 0 第47轮耗时为: 39.63秒
2019-04-22 21:16:46 Print By 0 第47轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第47轮Loss为:0.046806171315955
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第48轮准确率为: 0.9835
2019-04-22 21:16:46 Print By 0 第48轮耗时为: 40.955秒
2019-04-22 21:16:46 Print By 0 第48轮网络流量为:0.009295463562011719MB
2019-04-22 21:16:46 Print By 0 第48轮Loss为:0.04651652987180278
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 第49轮准确率为: 0.9839
2019-04-22 21:16:46 Print By 0 第49轮耗时为: 40.434秒
2019-04-22 21:16:46 Print By 0 第49轮网络流量为:0.009314537048339844MB
2019-04-22 21:16:46 Print By 0 第49轮Loss为:0.04473782109306194
2019-04-22 21:16:46 Print By 0 ---------------------------------------------
2019-04-22 21:16:46 Print By 0 总流量为:272.50377559661865MB
2019-04-22 21:16:46 Print By 0 已完成本次任务，耗时:1726.803秒
```
准确率：  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2clzfmyk5j30hs0dcglz.jpg)  
Loss：  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2cm3lpc3pj30hs0dcwew.jpg)  
时间开销：  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2cm9l2y8sj30hs0dc0t7.jpg)  


#### 代码优化目标
- 数据分发与收集时，并没有采用多线程并行点对点传递。目前采用串行的方式，利用for循环逐一分发。上述方式，并没有实现并行化，当数据集较大时，Master与Slave首次通信时会产生较大的通信延迟；当网络参数量大时，Slave向Master回传时会产生较大的通信延迟。为了避免出现上述问题，目前采用NFS进行数据集共享，避免了首次通信时的训练数据广播；对通信内容进行简化，具体内容如下：  
```python
    # Master首次推送信息结构
    data = []
    data.append([])                # 0-训练集
    data.append([])                # 1-训练集标签
    data.append([])                 # 2-测试集
    data.append([])                 # 3-测试集标签
    data.append(epochs)             # 4-训练轮数
    data.append(net_model)          # 5-网络细节
    data.append(data_disturibution) # 6-数据分块细节
```
```python
    # Master开始训练后推送信息结构
    gradient = []   # 梯度
    msg = []        # 标志符    1代表初始轮；2代表非初始轮
    msg.append(0)
    msg.append(gradient)
```
```python
    # Slave回传信息结构
    backd = []
    weights = model.get_weights()
    backd.append(weights)                               # 0 Weights
    backd.append(str(score[0]))                         # 1 Loss
    backd.append(str(score[1]))                         # 2 Accurary
    backd.append(str(float(train_time_gap / 1000)))     # 3 Train Time
    backd.append(str(float(test_time_gap / 1000)))      # 4 Test Time
```
- 聚合策略  

最优选举：  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2cf5yoz4dj30px0anglx.jpg)  
平均：  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2cf8huy1jj30pt0aqwet.jpg)  

目前尚未对加权聚合进行实现。  
- 训练数据随机化重构  
在Slave上，每轮内迭代训练时需要的训练数据分为两部分：固定不变的数据和随机选取的数据。超参数里设置一个阈值t，t表示每个Slave每轮训练时所用到的数据量占全部数据量的百分比。例如，假设当前有5个节点，那么每个节点会分到固定不变的20%数据。当t=0.45时，从全部数据里随机再抓取25%的数据。  
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2emuiq06nj30te0fwt95.jpg)
- 早停策略  
在实际训练时，设定迭代200轮，但是训练若干轮后准确率与Loss不再有质的提升，例如：  
```
Total params: 966,986
Trainable params: 966,986
Non-trainable params: 0
_________________________________________________________________
None
Using real-time data augmentation.
2019-04-21 21:23:57.733219: I tensorflow/core/platform/cpu_feature_guard.cc:137] Your CPU supports instructions that this TensorFlow binary was not compiled to use: SSE4.1 SSE4.2 AVX AVX2 FMA
Epoch 1/200
 - 475s - loss: 2.2740 - acc: 0.1760 - val_loss: 2.0250 - val_acc: 0.2921
Epoch 2/200
 - 468s - loss: 1.8543 - acc: 0.3413 - val_loss: 1.6795 - val_acc: 0.4152
Epoch 3/200
 - 472s - loss: 1.6832 - acc: 0.4162 - val_loss: 1.5938 - val_acc: 0.4538
Epoch 4/200
 - 482s - loss: 1.5586 - acc: 0.4729 - val_loss: 1.4819 - val_acc: 0.5071
Epoch 5/200
 - 469s - loss: 1.4437 - acc: 0.5204 - val_loss: 1.3929 - val_acc: 0.5483
Epoch 6/200
 - 476s - loss: 1.3536 - acc: 0.5579 - val_loss: 1.2646 - val_acc: 0.5938
Epoch 7/200
 - 471s - loss: 1.2791 - acc: 0.5847 - val_loss: 1.2192 - val_acc: 0.6139
Epoch 8/200
 - 494s - loss: 1.2117 - acc: 0.6102 - val_loss: 1.1802 - val_acc: 0.6277
......
Epoch 119/200
 - 454s - loss: 0.5225 - acc: 0.8690 - val_loss: 0.6366 - val_acc: 0.8415
Epoch 120/200
 - 461s - loss: 0.5201 - acc: 0.8683 - val_loss: 0.6296 - val_acc: 0.8421
Epoch 121/200
 - 490s - loss: 0.5235 - acc: 0.8671 - val_loss: 0.6285 - val_acc: 0.8429
Epoch 122/200
 - 484s - loss: 0.5238 - acc: 0.8686 - val_loss: 0.6200 - val_acc: 0.8441
Epoch 123/200
 - 500s - loss: 0.5170 - acc: 0.8688 - val_loss: 0.6249 - val_acc: 0.8454
Epoch 124/200
 - 509s - loss: 0.5209 - acc: 0.8676 - val_loss: 0.6313 - val_acc: 0.8438
Epoch 125/200
 - 495s - loss: 0.5184 - acc: 0.8690 - val_loss: 0.6323 - val_acc: 0.8417
Epoch 126/200
 - 484s - loss: 0.5195 - acc: 0.8690 - val_loss: 0.6308 - val_acc: 0.8437
Epoch 127/200
 - 480s - loss: 0.5238 - acc: 0.8659 - val_loss: 0.6258 - val_acc: 0.8450
Epoch 128/200
 - 481s - loss: 0.5206 - acc: 0.8698 - val_loss: 0.6282 - val_acc: 0.8436
Epoch 129/200
 - 491s - loss: 0.5192 - acc: 0.8687 - val_loss: 0.6277 - val_acc: 0.8446
Epoch 130/200
```
此时，可以认为以当前的超参与模型达到训练极限，继续训练并没有明显，应该停止训练，释放占用的集群资源。Keras框架提供了早停的参考策略：当训练准确率连续若干个回合无法明显提升，即可保留最优参数并退出计算。  
- 守护进程
目前尚未实现守护进程。守护进程是指运行在Master上的一个用于检测是否出现训练崩溃的进程。当守护进程检测到异常时，可自动加载前一次训练的进度，恢复执行现场，继续开始训练。  
- 重构代码，提高可读性。  

#### 各种网络及数据集的可用情况总结
![](http://ww1.sinaimg.cn/large/005L0VzSly1g2g2d6hvjmj30mf0k90tf.jpg)

## 总结
经过一段时间的整理，实验环境已经成功搭建。但是，相关组件仍需完善，将会在后续逐步更新。感谢聆听！